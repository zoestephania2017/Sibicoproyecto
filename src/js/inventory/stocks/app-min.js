import{validateVariable}from"../../module/url-min.js";import openModalCreate,{send}from"./openModalCreate-min.js";import openModalExists,{send as sendExists}from"./openModalExists-min.js";import createSelectOptions from"../../module/select-min.js";import{read}from"../../module/services/services-min.js";import{clearInput}from"../../module/modal-min.js";import{alert}from"../../module/alert-min.js";import{validateNumber,validateRequired}from"../../module/validate-min.js";import{generateSerie}from"../../module/generate-min.js";document.addEventListener("DOMContentLoaded",(async()=>{const e=document.querySelector("#btnAdd"),t=document.querySelector("#btnGenerateSerieCreate"),a=document.querySelector("#buttonModalCreate"),r=document.querySelector("#buttonModalExist"),i=document.querySelector("#buttonModalKardex"),o=document.querySelector("#buttonModalShow"),n=document.querySelector("#btnCloseCreate"),l=document.querySelector("#btnCloseExist"),c=document.querySelector("#btnCloseKardex"),d=document.querySelector("#btnCancelCreate"),s=document.querySelector("#btnCancelExist"),u=document.querySelector("#btnCancelKardex"),v=document.querySelector("#modalCreate"),m=document.querySelector("#modalExist"),p=document.querySelector("#modalShow"),x=document.querySelector("#frmCreate"),f=document.querySelector("#frmExist"),y=v.querySelector("#txtActionCreate"),g=m.querySelector("#txtActionExist"),S=document.querySelectorAll('[name="radioOptions"]'),q=document.getElementById("txtInputArticle"),b=document.getElementById("txtSelectArticle");let h=[],w=null,E="txtNewArticle",A=!0,k=new DataTable("#tblStocks",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/StockController.php",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"Codigo",data:"codigo_articulo"},{title:"Tipo",data:"tipo"},{title:"Nombre del articulo",data:"nombre_articulo"},{title:"Serie",data:"serie"},{title:"Disponible",data:"disponibilidad"},{title:"Imagen",data:"imagen"},{title:"Fecha de vencimiento",data:"fecha_vencimiento"}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fas fa-folder-plus text-green-500"></i> Agregar nuevo',action:function(e,t,r,i){y.value="001",openModalCreate(e,t,r,i,v,a)},className:"font-bold"},{text:'<i class="fas fa-plus-square text-emerald-500"></i> Agregar existencias',action:function(e,t,a,i){g.value="001",openModalExists(e,t,a,i,m,r)},className:"font-bold"},{text:'<i class="fas fa-barcode text-blue-500"></i> Números de serie',action:function(e,t,a,r){let i=t.row({selected:!0}).data();i?window.location.href=`../../dashboard/inventory/serie/?product=${i.codigo_articulo}`:alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-clipboard text-orange-500"></i> Kardex',action:function(e,t,a,r){let o=t.row({selected:!0}).data();o?(!function(e=null){w&&w.destroy();w=new DataTable("#tblKardex",{dom:"Bfrtip",async:!0,ajax:{url:`../../app/controllers/StockController.php?kardex=true&product=${e}`,type:"GET",dataSrc:""},pageLength:30,loading:!0,columns:[{title:"Fecha transacción",data:"fecha_transaccion"},{title:"Tipo",data:"nombre_tipo_documento"},{title:"Código documento",data:"codigo_documento"},{title:"Cantidad",data:"cantidad"},{title:"Precio unitario",data:"precio_unidad"},{title:"Descripción",data:"observaciones"},{title:"Disponible",data:"cantidad_acum"},{title:"Costo promedio",data:"valor_unidad_acum"},{title:"Valor total acumulado",data:"valor_total_acum"}],select:!1,responsive:!0,paging:!0,language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}})}(o.codigo_articulo),i.click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-info-circle text-sky-500"></i> Información del producto',action:function(e,t,a,r){let i=t.row({selected:!0}).data();i?(p.querySelector("#txtArticleShow").value=i.nombre_articulo,p.querySelector("#txtQuantityShow").value=i.disponibilidad,p.querySelector("#txtSerieShow").value=i.serie,o.click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"},drawCallback:function(e){const t=Array.from(this.api().rows().data());if(A&&t&&t.length>0){const e=new Date;t.filter((t=>{if(!t.fecha_vencimiento)return!1;return new Date(t.fecha_vencimiento)<=new Date(e.getTime()+6048e5)})).forEach((e=>{const t=new Date(`${e.fecha_vencimiento}T00:00:00-06:00`),a=new Date;if(t.toDateString()===a.toDateString()){return void D("Producto que vence hoy.",`El producto <span class="font-bold">${e.nombre_articulo}</span> con el código <span class="font-bold">(${e.codigo_articulo})</span> vence hoy.`)}if(t<a)return;const r=t-a,i=Math.floor(r/864e5),o=Math.floor(r%864e5/36e5);let n="";if(i>0&&(n+=`${i} día${i>1?"s":""}`),o>0&&(""!==n&&(n+=" y "),n+=`${o} hora${o>1?"s":""}`),""!==n){D("Producto próximo a vencer",`El producto <span class="font-bold">${e.nombre_articulo}</span> con el código <span class="font-bold">(${e.codigo_articulo})</span> vence en <span class="font-semibold italic">${n}</span>.`)}})),A=!1}}});t.addEventListener("click",(()=>{let e=generateSerie(5,3);validateRequired(v.querySelector("#txtSeries").value)&&(v.querySelector("#txtSeries").value=""),v.querySelector("#txtSeries").value=e}));let C=new DataTable("#tblItems",{dom:"Bfrtip",async:!0,dataSrc:h,columns:[{title:"ID",data:"id"},{title:"Cantidad",data:"cantidad"},{title:"Articulo",data:"articulo"},{title:"Serie",data:"serie"},{title:"Precio Unitario",data:"precio_unidad"},{title:"Imagen",data:"imagen"},{title:"Tipo",data:"tipo"},{title:"Unidad",data:"unidad"},{title:"Peso",data:"peso"},{title:"Medida",data:"medida"},{title:"Fecha de vencimiento",data:"fecha_vencimiento"}],searching:!1,select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-trash text-rose-500"></i> Eliminar',action:function(e,t,a,r){let i=t.row({selected:!0}).data();i?function(e){const t=h.findIndex((t=>t.id===e));-1!==t&&(h.splice(t,1),C.clear(),C.rows.add(h),C.draw())}(i.id):alert("Aviso","Debe seleccionar un registro para eliminar.","info","OK",!1)},className:"btn-delete font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});function D(e,t){const a=document.getElementById("notificationContainer"),r=document.createElement("div"),i=(new Date).toLocaleString("es-HN",{weekday:"long",day:"2-digit",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0,timeZone:"America/Tegucigalpa"});r.innerHTML=`\n            <div id="toast-notification" class="w-full max-w-xs p-4 text-white bg-slate-700 rounded-lg shadow mt-4" role="alert">\n                <div class="flex items-center mb-3">\n                    <span class="mb-1 text-sm font-semibold text-blue-500">Nueva notificación</span>\n                    <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-slate-200 justify-center items-center flex-shrink-0 text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8" data-dismiss-target="#toast-notification" aria-label="Close">\n                        <span class="sr-only">Close</span>\n                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">\n                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />\n                        </svg>\n                    </button>\n                </div>\n                <div class="flex items-center">\n                    <div class="ml-1 font-normal">\n                        <div class="text-md font-semibold text-white mb-2">${e}</div>\n                        <div class="text-md font-normal mb-6">${t}</div>\n                        <span class="text-sm font-medium text-blue-500">${i}</span>\n                    </div>\n                </div>\n            </div>\n        `,a.appendChild(r);r.querySelector("button").addEventListener("click",(()=>{a.removeChild(r)}))}await createSelectOptions("#txtType","../../app/controllers/StockController.php?type=true","codigo","nombre"),await async function(){const e=await read("../../app/controllers/StockController.php?only=true");let t=document.querySelector("#txtSelectArticle");for(let a=0;a<e.length;a++)t.innerHTML+=`<option value="${e[a].codigo}">${e[a].descripcion}</option>`}(),x.addEventListener("submit",(async e=>{e.preventDefault();let t=v.querySelector("#txtActionCreate").value;switch(t){case"001":if(function(){if(!validateRequired(y.value))return alert("Aviso","Al parecer hay un error, por favor refresque la pagina.","warning","Ok",!0),!1;if(0===h.length)return alert("Aviso","Debe agregar al menos un articulo.","warning","Ok",!0),!1;return!0}()){let e={items:h},a=await send(e,t);if(a){let e=a?.success?"Transacción exitosa":"Error en la transacción",t=a?.success?"success":"warning";alert(e,a.message,t,"Ok",!0)}k.ajax.reload(),n.click()}else a.click();break;default:break}})),f.addEventListener("submit",(async e=>{e.preventDefault();let t=m.querySelector("#txtActionExist").value;switch(t){case"001":if(function(){if(!validateRequired(m.querySelector("#txtCodeExist").value))return alert("Aviso","Al parecer hay un error, por favor refresque la pagina.","warning","Ok",!0),!1;if(!validateNumber(m.querySelector("#txtCodeExist").value))return alert("Aviso","Al parecer hay un error, por favor refresque la pagina.","warning","Ok",!0),!1;if(!validateRequired(m.querySelector("#txtArticleExist").value))return alert("Aviso","El nombre del articulo es requerido.","warning","Ok",!0),!1;if(!validateRequired(m.querySelector("#txtPriceExist").value))return alert("Aviso","El precio unitario es requerido.","warning","Ok",!0),!1;if(!validateNumber(m.querySelector("#txtQuantityExist").value))return alert("Aviso","La cantidad disponible es requerida.","warning","Ok",!0),!1;if(!validateRequired(m.querySelector("#txtQuantity2Exist").value))return alert("Aviso","La cantidad es requerida.","warning","Ok",!0),!1;return!0}()){let e={codigo:m.querySelector("#txtCodeExist").value,cantidad:m.querySelector("#txtQuantity2Exist").value,cantidad_disponible:m.querySelector("#txtQuantityExist").value,precio:m.querySelector("#txtPriceExist").value,descripcion:m.querySelector("#txtDescriptionExist").value||"N/A"},a=await sendExists(e,t);if(a){let e=a?.success?"Transacción exitosa":"Error en la transacción",t=a?.success?"success":"warning";alert(e,a.message,t,"Ok",!0)}k.ajax.reload(),l.click()}else r.click();break;default:break}})),b.addEventListener("change",(async()=>{let e=b.value,t=await read(`../../app/controllers/StockController.php?single=true&product=${e}`);v.querySelector("#txtCodeCreate").value=t[0].codigo,v.querySelector("#txtMeasure").value=t[0].unidad,v.querySelector("#txtWeight").value=t[0].peso,v.querySelector("#txtVolume").value=t[0].volumen,v.querySelector("#txtSeries").value=t[0].serie,v.querySelector("#txtExpiration").value=t[0].fecha_vencimiento})),S.forEach((e=>{e.addEventListener("click",(function(){"txtNewArticle"===e.id?(q.classList.remove("hidden"),b.classList.add("hidden"),E="txtNewArticle"):"txtExistArticle"===e.id&&(q.classList.add("hidden"),b.classList.remove("hidden"),E="txtExistArticle")})),e.addEventListener("change",(function(){"txtNewArticle"===e.id&&(v.querySelector("#txtMeasure").value="",v.querySelector("#txtWeight").value="0",v.querySelector("#txtPrice").value="0",v.querySelector("#txtVolume").value="0",v.querySelector("#txtSeries").value="")}))})),await async function(){if(validateVariable("add")?.exists){const e=document.querySelector("#buttonModalCreate"),t=document.querySelector("#modalTitleCreate"),a=document.querySelector("#txtActionCreate"),r=document.querySelector("#btnModalCreate");t.innerHTML="Agregar existencias",a.value="001",r.innerHTML="Guardar datos",e.click()}}(),u.addEventListener("click",(()=>{w.destroy(),w=null})),d.addEventListener("click",(()=>{clearInput(x),h=[],C.clear(),C.rows.add(h),C.draw()})),c.addEventListener("click",(()=>{w.destroy(),w=null})),n.addEventListener("click",(()=>{clearInput(x),h=[],C.clear(),C.rows.add(h),C.draw()})),l.addEventListener("click",(()=>{clearInput(f)})),s.addEventListener("click",(()=>{clearInput(f)})),e.addEventListener("click",(()=>{if(!validateRequired(v.querySelector("#txtType").value))return void alert("Aviso","Debe seleccionar un tipo.","info","OK",!1);if("txtNewArticle"===E){if(!validateRequired(q.value))return void alert("Aviso","Debe ingresar un artículo.","info","OK",!1)}else if("txtExistArticle"===E&&!validateRequired(b.value))return void alert("Aviso","Debe seleccionar un artículo.","info","OK",!1);if(!validateRequired(v.querySelector("#txtMeasure").value))return void alert("Aviso","Debe ingresar una unidad de medida.","info","OK",!1);if(!validateRequired(v.querySelector("#txtWeight").value))return void alert("Aviso","Debe ingresar un peso.","info","OK",!1);if(!validateRequired(v.querySelector("#txtVolume").value))return void alert("Aviso","Debe ingresar un volumen.","info","OK",!1);if(!validateRequired(v.querySelector("#txtQuantity").value))return void alert("Aviso","Debe ingresar una cantidad.","info","OK",!1);if(!validateRequired(v.querySelector("#txtPrice").value))return void alert("Aviso","Debe ingresar un precio unitario.","info","OK",!1);let e={id:h.length+1,tipo:v.querySelector("#txtType").value,codigo:"txtNewArticle"===E?null:b.value,articulo:"txtNewArticle"===E?q.value:b.options[b.selectedIndex].text,unidad:v.querySelector("#txtMeasure").value,peso:v.querySelector("#txtWeight").value,medida:v.querySelector("#txtVolume").value,cantidad:v.querySelector("#txtQuantity").value,serie:v.querySelector("#txtSeries").value||"N/A",precio_unidad:v.querySelector("#txtPrice").value,fecha_vencimiento:v.querySelector("#txtExpiration").value||null,imagen:"sinimagen.jpg"};h.push(e),C.clear(),C.rows.add(h),C.draw(),v.querySelector("#txtType").value="",v.querySelector("#txtCodeCreate").value="",v.querySelector("#txtMeasure").value="",v.querySelector("#txtWeight").value="",v.querySelector("#txtVolume").value="",v.querySelector("#txtQuantity").value="",v.querySelector("#txtSeries").value="",v.querySelector("#txtPrice").value="",v.querySelector("#txtExpiration").value="",q.value="",b.value="",E="txtNewArticle"}))}));