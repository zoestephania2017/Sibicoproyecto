import{clearInput}from"../../../module/modal-min.js";import{validateRequired,validateNumber}from"../../../module/validate-min.js";import openModal,{send}from"./openModal-min.js";import{alert}from"../../../module/alert-min.js";import{generateSerie}from"../../../module/generate-min.js";document.addEventListener("DOMContentLoaded",(async()=>{const e=document.querySelector("#modal"),t=document.querySelector("#buttonModal"),r=document.querySelector("#btnCancel"),a=document.querySelector("#frmSerie"),n=document.querySelector("#txtAction"),o=document.querySelector("#btnClose"),l=document.querySelector("#btnGenerateSerie"),i=await async function(){return new URLSearchParams(window.location.search).get("product")}();let c=new DataTable("#tblSeries",{dom:"Bfrtip",async:!0,ajax:{url:`../../../app/controllers/SerieController.php?product=${i}`,type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"Nombre del articulo",data:"nombre"},{title:"Serie",data:"serie"},{title:"Imagen del documento",data:"imagen"},{title:"Estado",data:"estado",render:function(e){return`\n                    <div class="flex flex-row gap-2 items-center justify-between">\n                        <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border ${"ACTIVO"===e?"bg-green-100 text-green-800 border-green-400":"bg-red-100 text-red-800 border-red-400"}">${e}</span>\n                    </div>\n                `}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fas fa-folder-plus text-green-500"></i> Agregar',action:function(r,a,o,l){n.value="001",e.querySelector("#txtCode").value=i,openModal(r,a,o,l,e,t)},className:"font-bold"},{text:'<i class="fa-solid fa-trash text-red-500"></i> Eliminar',action:function(t,r,a,o){let l=r.row({selected:!0}).data();l?(n.value="002",e.querySelector("#txtCode").value=l.codigo_producto,e.querySelector("#txtSerie").value=l.serie,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-arrow-circle-left text-blue-500"></i> Regresar a Existencias',action:function(){window.location="../stocks.php"},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});r.addEventListener("click",(()=>{clearInput(a)})),o.addEventListener("click",(()=>{clearInput(a)})),l.addEventListener("click",(()=>{let t=generateSerie(5,3);validateRequired(e.querySelector("#txtSerie").value)&&(e.querySelector("#txtSerie").value=""),e.querySelector("#txtSerie").value=t})),a.addEventListener("submit",(async t=>{t.preventDefault();let r=e.querySelector("#txtAction").value;switch(r){case"001":if(a()){let t={codigo:e.querySelector("#txtCode").value,serie:e.querySelector("#txtSerie").value},a=await send(t,r);if(a){let e=a?.success?"Transacción exitosa":"Error en la transacción",t=a?.success?"success":"warning";alert(e,a.message,t,"Ok",!0)}c.ajax.reload(),o.click()}break;case"002":a()&&swal("Estas seguro que deseas eliminar la serie?",{title:"Eliminar serie",icon:"warning",dangerMode:!0,buttons:{yes:{text:"Si",value:"yes"},not:{text:"No",value:"not"}}}).then((async t=>{switch(t){case"yes":let t={codigo:e.querySelector("#txtCode").value,serie:e.querySelector("#txtSerie").value},a=await send(t,r);if(a){let e=a?.success?"Transacción exitosa":"Error en la transacción",t=a?.success?"success":"warning";alert(e,a.message,t,"Ok",!0)}c.ajax.reload(),o.click();break;case"not":break}}))}function a(){return validateRequired(e.querySelector("#txtCode").value)?validateNumber(e.querySelector("#txtCode").value)?!!validateRequired(e.querySelector("#txtSerie").value)||(alert("Error","El serie no puede estar vació.","warning","Ok",!0),!1):(alert("Error","El código debe ser un numero.","warning","Ok",!0),!1):(alert("Error","El código no puede estar vació.","warning","Ok",!0),!1)}}))}));