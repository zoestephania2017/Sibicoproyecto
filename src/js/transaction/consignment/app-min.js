import openModal,{send}from"./modalOptions-min.js";import{clearInput}from"../../module/modal-min.js";import{alert}from"../../module/alert-min.js";import{validateRequired,validateNumber}from"../../module/validate-min.js";import{read,viewInvoice}from"../../module/services/services-min.js";document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#modal"),t=document.querySelector("#buttonModal"),a=document.querySelector("#btnCancel"),n=document.querySelector("#btnPrint"),r=document.querySelector("#frmConsignment"),o=document.querySelector("#txtAction"),l=document.querySelector("#btnClose"),i=document.querySelector("#txtConsignment"),c=document.querySelector("#btnAdd"),s=document.querySelector("#txtDiscountCheck"),d=document.querySelector("#txtISVCheck");let u=[],m={},f=new DataTable("#tblConsignments",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/ConsignmentController.php",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"Codigo",data:"codigo_factura"},{title:"Numero",data:"numero"},{title:"Fecha de creación",data:"fecha_creacion"},{title:"Fecha de vencimiento",data:"fecha_vencimiento"},{title:"Cliente",data:"cliente"},{title:"Responsable",data:"responsable"},{title:"Estado",data:"estado",render:function(e){return`\n                        <div class="flex flex-row gap-2 items-center justify-between">\n                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border ${"ACTIVO"===e?"bg-green-100 text-green-800 border-green-400":"bg-red-100 text-red-800 border-red-400"}">${e}</span>\n                        </div>\n                    `}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-circle-plus text-green-500"></i> Crear',action:async function(a,n,r,l){o.value="001";const c=await read("../../app/controllers/ConsignmentController.php?code=true");i.value=c,openModal(a,n,r,l,e,t)},className:"font-bold"},{text:'<i class="fas fa-minus-circle text-red-500"></i> Anular',action:function(t,a,n,r){let l=a.row({selected:!0}).data();l?(o.value="002",e.querySelector("#txtCode").value=l.codigo_factura,e.querySelector("#txtConsignment").value=l.numero,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-calendar-times text-red-500"></i> Expiradas',action:function(t,a,n,r){o.value="003",e.querySelector("#btnModal").click()},className:"font-bold"},{text:'<i class="fa-solid fa-eye text-orange-500"></i> Ver',action:function(a,n,r,l){o.value="005",openModal(a,n,r,l,e,t,u,x,g)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}}),g=new DataTable("#tblItems",{dom:"Bfrtip",async:!0,dataSrc:u,columns:[{title:"Codigo",data:"correlativo"},{title:"Cantidad",data:"cantidad"},{title:"Descripcion",data:"descripcion"},{title:"Precio unitario",data:"precio_unidad"},{title:"Total",data:"total"}],searching:!1,select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-trash text-rose-500"></i> Eliminar',action:function(e,t,a,n){let r=t.row({selected:!0}).data();r?function(e){const t=u.findIndex((t=>t.id===e));-1!==t&&(u.splice(t,1),g.clear(),g.rows.add(u),g.draw());v()}(r.id):alert("Aviso","Debe seleccionar un registro para eliminar.","info","OK",!1)},className:"btn-delete font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});function p(){u=[],m={},c.classList.remove("hidden"),c.disabled=!1,e.querySelector("#btnModal").disabled=!1,e.querySelector("#btnModal").classList.remove("hidden"),n.classList.add("hidden"),n.disabled=!0;let t=g.table().container().querySelectorAll(".btn-delete");if(t&&t.length>0)for(let e=0;e<t.length;e++)t[e].classList.remove("disabled");g.clear(),g.rows.add(u),g.draw(),v()}function v(){let e=0,t=0,a=0,n=0;u.forEach((t=>{e+=t.total})),s.checked&&(t=Math.round(.3*e*100)/100),d.checked&&(a=Math.round(.12*(e-t)*100)/100),n=Math.round(100*(e-t+a))/100,x(e,t,a,n)}function x(e,t,a,n){document.querySelector("#txtSubtotal").value=e,document.querySelector("#txtDiscount").value=t,document.querySelector("#txtISV").value=a,document.querySelector("#txtTotal").value=n,m={subtotal:e,descuento:t,isv:a,total:n}}function b(){return validateRequired(e.querySelector("#txtAction").value)?validateRequired(e.querySelector("#txtConsignment").value)?validateRequired(e.querySelector("#txtClient").value)?validateRequired(e.querySelector("#txtDate").value)?validateRequired(e.querySelector("#txtDateExpiration").value)?validateRequired(e.querySelector("#txtResponsible").value)?!(!u.length>0)||(alert("Error","Por favor ingrese al menos un item.","warning","Ok",!0),!1):(alert("Campo requerido","Por favor ingrese el responsable es requerido.","warning","Ok",!0),!1):(alert("Campo requerido","Por favor ingrese la fecha de vencimiento es requerido.","warning","Ok",!0),!1):(alert("Campo requerido","Por favor ingrese la fecha de creación es requerido.","warning","Ok",!0),!1):(alert("Campo requerido","Por favor ingrese el cliente es requerido.","warning","Ok",!0),!1):(alert("Campo requerido","Por favor ingrese el numero de consignación es requerido.","warning","Ok",!0),!1):(alert("Error","Por favor refresque la pagina.","warning","Ok",!0),!1)}a.addEventListener("click",(()=>{clearInput(r,!0,["txtConsignment","txtSubtotal","txtTotal","txtDiscount","txtISV"],["txtDiscountCheck","txtISVCheck"]),p()})),l.addEventListener("click",(()=>{clearInput(r,!0,["txtConsignment","txtSubtotal","txtTotal","txtDiscount","txtISV"],["txtDiscountCheck","txtISVCheck"]),p()})),c.addEventListener("click",(()=>{let e=document.querySelector("#txtQuantity"),t=document.querySelector("#txtDescription"),a=document.querySelector("#txtPrice"),n=0;e.value||t.value||a.value?validateNumber(e.value)?validateNumber(a.value)?(n=parseFloat(e.value)*parseFloat(a.value),u.push({correlativo:u.length+1,cantidad:e.value,descripcion:t.value,precio_unidad:a.value,total:n}),g.clear(),g.rows.add(u),g.draw(),v()):alert("Aviso","El precio debe ser un número.","warning","Ok",!0):alert("Aviso","La cantidad debe ser un número.","warning","Ok",!0):alert("Aviso","Debe ingresar la cantidad, descripción y precio.","warning","Ok",!0)})),n.addEventListener("click",(async()=>{b()?e.querySelector("#txtCode").value&&await viewInvoice(`../../app/controllers/ConsignmentController.php?print=true&id=${e.querySelector("#txtCode").value}`):alert("Aviso","Debe completar todos los campos.","warning","Ok",!0)})),s.addEventListener("change",v),d.addEventListener("change",v),r.addEventListener("submit",(async a=>{a.preventDefault();let n=e.querySelector("#txtAction").value;switch(n){case"001":if(b()){let t={factura:{consignacion:e.querySelector("#txtConsignment").value,cliente:e.querySelector("#txtClient").value,fecha_creacion:e.querySelector("#txtDate").value,fecha_vencimiento:e.querySelector("#txtDateExpiration").value,responsable:e.querySelector("#txtResponsible").value,nota:e.querySelector("#txtNote").value||"N/A"},items:u,total:m},a=await send(t,n);if(a){let e=a?.success?"Transacción exitosa":"Error en la transacción",t=a?.success?"success":"warning";alert(e,a.message,t,"Ok",!0)}f.ajax.reload(),l.click()}break;case"002":(function(){if(!validateRequired(e.querySelector("#txtAction").value||!validateRequired(e.querySelector("#txtCode").value||!validateRequired(e.querySelector("#txtConsignment").value))))return alert("Error","Por favor refresque la pagina.","warning","Ok",!0),!1;return!0})()&&swal("Estas seguro que desea anular la factura?",{title:"Eliminar factura",icon:"warning",dangerMode:!0,buttons:{yes:{text:"Si",value:"yes"},not:{text:"No",value:"not"}}}).then((async t=>{switch(t){case"yes":let t={codigo_factura:e.querySelector("#txtCode").value,consignacion:e.querySelector("#txtConsignment").value},a=await send(t,n);if(a){let e=a?.success?"Transaccion exitosa":"Error en la transaccion",t=a?.success?"success":"warning";alert(e,a.message,t,"Ok",!0)}f.ajax.reload(),l.click();break;case"not":break}}));break;case"003":f&&f.destroy(),f=new DataTable("#tblConsignments",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/ConsignmentController.php?expired=true",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"Codigo",data:"codigo_factura"},{title:"Numero",data:"numero"},{title:"Fecha de creación",data:"fecha_creacion"},{title:"Fecha de vencimiento",data:"fecha_vencimiento"},{title:"Cliente",data:"cliente"},{title:"Responsable",data:"responsable"},{title:"Estado",data:"estado",render:function(e){return`\n                                    <div class="flex flex-row gap-2 items-center justify-between">\n                                        <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border ${"ACTIVO"===e?"bg-green-100 text-green-800 border-green-400":"bg-red-100 text-red-800 border-red-400"}">${e}</span>\n                                    </div>\n                                `}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-circle-plus text-green-500"></i> Crear',action:async function(a,n,r,l){o.value="001";const c=await read("../../app/controllers/ConsignmentController.php?code=true");i.value=c,openModal(a,n,r,l,e,t)},className:"font-bold"},{text:'<i class="fas fa-minus-circle text-red-500"></i> Anular',action:function(t,a,n,r){let l=a.row({selected:!0}).data();l?(o.value="002",e.querySelector("#txtCode").value=l.codigo_factura,e.querySelector("#txtConsignment").value=l.numero,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-th-list text-emerald-500"></i> Mostrar todos los registros',action:function(t,a,n,r){o.value="004",e.querySelector("#btnModal").click()},className:"font-bold"},{text:'<i class="fa-solid fa-eye text-orange-500"></i> Ver',action:function(a,n,r,l){o.value="005",openModal(a,n,r,l,e,t,u,x,g)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});break;case"004":f&&f.destroy(),f=new DataTable("#tblConsignments",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/ConsignmentController.php",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"Codigo",data:"codigo_factura"},{title:"Numero",data:"numero"},{title:"Fecha de creación",data:"fecha_creacion"},{title:"Fecha de vencimiento",data:"fecha_vencimiento"},{title:"Cliente",data:"cliente"},{title:"Responsable",data:"responsable"},{title:"Estado",data:"estado",render:function(e){return`\n                                    <div class="flex flex-row gap-2 items-center justify-between">\n                                        <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border ${"ACTIVO"===e?"bg-green-100 text-green-800 border-green-400":"bg-red-100 text-red-800 border-red-400"}">${e}</span>\n                                    </div>\n                                `}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-circle-plus text-green-500"></i> Crear',action:async function(a,n,r,l){o.value="001";const c=await read("../../app/controllers/ConsignmentController.php?code=true");i.value=c,openModal(a,n,r,l,e,t)},className:"font-bold"},{text:'<i class="fas fa-minus-circle text-red-500"></i> Anular',action:function(t,a,n,r){let l=a.row({selected:!0}).data();l?(o.value="002",e.querySelector("#txtCode").value=l.codigo_factura,e.querySelector("#txtConsignment").value=l.numero,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-calendar-times text-red-500"></i> Expiradas',action:function(t,a,n,r){o.value="003",e.querySelector("#btnModal").click()},className:"font-bold"},{text:'<i class="fa-solid fa-eye text-orange-500"></i> Ver',action:function(a,n,r,l){o.value="005",openModal(a,n,r,l,e,t,u,x,g)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});break;default:break}}))}));