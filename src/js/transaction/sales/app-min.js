import openModal,{send}from"./modalOptions-min.js";import{clearInput}from"../../module/modal-min.js";import{alert}from"../../module/alert-min.js";import{validateRequired,validateEmail,validatePhoneNumber}from"../../module/validate-min.js";import createSelection,{resetSelectOptions}from"../../module/select-min.js";import{viewInvoice,read}from"../../module/services/services-min.js";document.addEventListener("DOMContentLoaded",(async()=>{const e=document.querySelector("#modal"),t=document.querySelector("#modalClient"),r=document.querySelector("#buttonModal"),a=document.querySelector("#btnCancel"),l=document.querySelector("#frmSale"),o=document.querySelector("#frmClient"),n=document.querySelector("#txtAction"),i=document.querySelector("#btnClose"),s=document.querySelector("#btnCloseClient"),c=document.querySelector("#btnAdd"),d=document.querySelector("#btnPrint"),u=document.querySelector("#txtSerie"),p=document.querySelector("#txtSerieList");let v=[];await createSelection("#txtTypeDocument","../../app/controllers/ProceedingController.php?winery=true","codigo","descripcion"),await createSelection("#txtInstitution","../../app/controllers/ClientController.php?institution=true","codigo","descripcion");let f=new DataTable("#tblSales",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/SaleController.php",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"ID",data:"codigo_factura"},{title:"Codigo",data:"numero"},{title:"Fecha de emisión",data:"fecha_transaccion"},{title:"Cliente",data:"cliente"},{title:"Responsable",data:"responsable"},{title:"Estado",data:"estado",render:function(e){switch(e){case"ACTIVO":return`\n                            <div class="flex flex-row gap-2 items-center justify-between">\n                                <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-green-100 text-green-800 border-green-400">${e}</span>\n                            </div>\n                        `;case"ANULADO":return`\n                            <div class="flex flex-row gap-2 items-center justify-between">\n                                <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-red-100 text-red-800 border-red-400">${e}</span>\n                            </div>\n                        `;case"DEVOLUCION":return`\n                            <div class="flex flex-row gap-2 items-center justify-between">\n                                <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-yellow-100 text-yellow-800 border-yellow-400">${e}</span>\n                            </div>\n                        `}}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-circle-plus text-green-500"></i> Crear',action:function(t,a,l,o){n.value="001",openModal(t,a,l,o,e,r)},className:"font-bold"},{text:'<i class="fas fa-minus-circle text-red-500"></i> Anular',action:function(t,r,a,l){let o=r.row({selected:!0}).data();o?(n.value="002",e.querySelector("#txtCode").value=o.codigo_factura,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-calendar-times text-red-500"></i> Expiradas',action:function(t,r,a,l){n.value="003",e.querySelector("#btnModal").click()},className:"font-bold"},{text:'<i class="fa-solid fa-eye text-orange-500"></i> Ver',action:function(t,a,l,o){n.value="005",openModal(t,a,l,o,e,r,v,x)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}}),x=new DataTable("#tblItems",{dom:"Bfrtip",async:!0,dataSrc:v,pageLength:15,loading:!0,columns:[{title:"Cantidad",data:"cantidad"},{title:"Codigo",data:"correlativo"},{title:"Descripción",data:"descripcion"},{title:"Serie",data:"serie"},{title:"Precio unidad",data:"precio_unidad"},{title:"Descuento",data:"descuento"},{title:"Total",data:"total"}],searching:!1,select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-trash text-rose-500"></i> Eliminar',action:function(e,t,r,a){let l=t.row({selected:!0}).data();l?function(e){const t=v.findIndex((t=>t.correlativo===e));-1!==t&&(v.splice(t,1),x.clear(),x.rows.add(v),x.draw())}(l.correlativo):alert("Aviso","Debe seleccionar un registro para eliminar.","info","OK",!1)},className:"btn-delete font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});function m(){v=[],c.classList.remove("hidden"),c.disabled=!1,e.querySelector("#btnModal").disabled=!1,e.querySelector("#btnModal").classList.remove("hidden"),e.querySelector("#divCost1").classList.remove("hidden"),e.querySelector("#divCost2").classList.remove("hidden"),e.querySelector("#divCost3").classList.remove("hidden"),e.querySelector("#divTotal").classList.add("hidden"),e.querySelector("#btnPrint").disabled=!0,e.querySelector("#btnPrint").classList.add("hidden"),e.querySelector("#divCorrelative").classList.add("hidden"),e.querySelector("#txtDate").disabled=!0,e.querySelector("#txtDate").readonly=!0;let t=x.table().container().querySelectorAll(".btn-delete");if(t&&t.length>0)for(let e=0;e<t.length;e++)t[e].classList.remove("disabled");x.clear(),x.rows.add(v),x.draw()}u.addEventListener("keyup",(async e=>{let t=e.target.value;t.length>=2?await createSelection("#txtSerieList",`../../app/controllers/SaleController.php?serie=${t}&type=1`,"correlativo","serie"):resetSelectOptions("#txtSerieList")})),d.addEventListener("click",(async()=>{e.querySelector("#txtCode").value?e.querySelector("#txtCode").value&&await viewInvoice(`../../app/controllers/SaleController.php?print=true&id=${e.querySelector("#txtCode").value}`):alert("Aviso","Debe completar todos los campos.","warning","Ok",!0)})),p.addEventListener("change",(async t=>{e.querySelector("#txtArticle").value="",e.querySelector("#txtCost").value="",e.querySelector("#txtAvailability").value="",e.querySelector("#txtDescription").value="",e.querySelector("#txtId").value="",e.querySelector("#txtCor").value="",e.querySelector("#txtArticleCode").value="";let r=t.target.options[t.target.selectedIndex].textContent,a=await read(`../../app/controllers/SaleController.php?serie=${r}&type=2`);0!==a.length?(e.querySelector("#txtArticle").value=a[0]?.nombre,e.querySelector("#txtCost").value=a[0]?.valor_unidad_acum,e.querySelector("#txtAvailability").value=a[0]?.disponibilidad,e.querySelector("#txtDescription").value=a[0]?.descripcion,e.querySelector("#txtId").value=a[0]?.codigo,e.querySelector("#txtCor").value=a[0]?.correlativo,e.querySelector("#txtArticleCode").value=a[0]?.codigo_producto):alert("Aviso","No se encontraron registros.","info","OK",!1)})),a.addEventListener("click",(()=>{clearInput(l),m()})),i.addEventListener("click",(()=>{clearInput(l),m()})),s.addEventListener("click",(()=>{clearInput(o)})),c.addEventListener("click",(()=>{if(!validateRequired(e.querySelector("#txtSerie").value))return void alert("Error","Debe ingresar la serie","warning","Ok",!0);if(!validateRequired(e.querySelector("#txtArticle").value))return void alert("Error","Debe seleccionar un articulo","warning","Ok",!0);let t=0,r=e.querySelector("#txtPrice"),a=e.querySelector("#txtQuantity");a.value||r.value?(t=parseFloat(a.value)*parseFloat(r.value),v.push({cantidad:a.value,correlativo:e.querySelector("#txtId").value,serie:e.querySelector("#txtSerie").value,descripcion:e.querySelector("#txtDescription").value,precio_unidad:r.value,descuento:0,total:t.toFixed(2)}),x.clear(),x.rows.add(v),x.draw()):alert("Error","Debe ingresar el precio y la cantidad","warning","Ok",!0)})),l.addEventListener("submit",(async t=>{t.preventDefault();let a=e.querySelector("#txtAction").value;switch(a){case"001":if(function(){if(!validateRequired(e.querySelector("#txtAction").value))return alert("Error","Por favor refresque la pagina.","warning","Ok",!0),!1;if(!validateRequired(e.querySelector("#txtTypeDocument").value))return alert("Campo requerido","El tipo de documento es requerido.","warning","Ok",!0),!1;if(!validateRequired(e.querySelector("#txtReceiver").value))return alert("Campo requerido","El nombre de la persona que recibe el documento es requerido.","warning","Ok",!0),!1;if(!validateRequired(e.querySelector("#txtDelivery").value))return alert("Campo requerido","El nombre de la persona que entrega el documento es requerido.","warning","Ok",!0),!1;if(!validateRequired(e.querySelector("#txtDate").value))return alert("Campo requerido","La fecha de emisión es requerido.","warning","Ok",!0),!1;if(!v.length>0)return alert("Error","Por favor ingrese al menos un item.","warning","Ok",!0),!1;return!0}()){let t={tipo_documento:e.querySelector("#txtTypeDocument").value,receptor:e.querySelector("#txtReceiver").value,telefono:e.querySelector("#txtPhone").value||"N/A",emisor:e.querySelector("#txtDelivery").value,fecha:e.querySelector("#txtDate").value,institucion:e.querySelector("#txtInstitution").options[e.querySelector("#txtInstitution").selectedIndex].textContent||"N/A",codigo_institucion:e.querySelector("#txtInstitution").value||"N/A",rtn:e.querySelector("#txtRTN").value||"N/A",cargo:e.querySelector("#txtPosition").value||"N/A",nota:e.querySelector("#txtNote").value||"N/A",detalle:v},r=await send(t,a);if(r){let e=r?.success?"Transacción exitosa":"Error en la transacción",t=r?.success?"success":"warning";alert(e,r.message,t,"Ok",!0)}f.ajax.reload(),i.click()}break;case"002":(function(){if(!validateRequired(e.querySelector("#txtAction").value||!validateRequired(e.querySelector("#txtCode").value)))return alert("Error","Por favor refresque la pagina.","warning","Ok",!0),!1;if(!validateRequired(e.querySelector("#txtCode").value))return alert("Error","El codigo no puede estar vació.","warning","Ok",!0),!1;return!0})()&&swal("Estas seguro que desea anular la acta de entrega?",{title:"Eliminar acta de entrega",icon:"warning",dangerMode:!0,buttons:{yes:{text:"Si",value:"yes"},not:{text:"No",value:"not"}}}).then((async t=>{switch(t){case"yes":let t={codigo:e.querySelector("#txtCode").value},r=await send(t,a);if(r){let e=r?.success?"Transaccion exitosa":"Error en la transaccion",t=r?.success?"success":"warning";alert(e,r.message,t,"Ok",!0)}f.ajax.reload(),i.click();break;case"not":break}}));break;case"003":f&&f.destroy(),f=new DataTable("#tblSales",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/SaleController.php?expired=true",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"ID",data:"codigo_factura"},{title:"Codigo",data:"numero"},{title:"Fecha de emisión",data:"fecha_transaccion"},{title:"Cliente",data:"cliente"},{title:"Responsable",data:"responsable"},{title:"Estado",data:"estado",render:function(e){switch(e){case"ACTIVO":return`\n                                        <div class="flex flex-row gap-2 items-center justify-between">\n                                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-green-100 text-green-800 border-green-400">${e}</span>\n                                        </div>\n                                    `;case"ANULADO":return`\n                                        <div class="flex flex-row gap-2 items-center justify-between">\n                                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-red-100 text-red-800 border-red-400">${e}</span>\n                                        </div>\n                                    `;case"DEVOLUCION":return`\n                                        <div class="flex flex-row gap-2 items-center justify-between">\n                                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-yellow-100 text-yellow-800 border-yellow-400">${e}</span>\n                                        </div>\n                                    `}}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-circle-plus text-green-500"></i> Crear',action:function(t,a,l,o){n.value="001",openModal(t,a,l,o,e,r)},className:"font-bold"},{text:'<i class="fas fa-minus-circle text-red-500"></i> Anular',action:function(t,r,a,l){let o=r.row({selected:!0}).data();o?(n.value="002",e.querySelector("#txtCode").value=o.codigo_factura,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-th-list text-emerald-500"></i> Mostrar todos los registros',action:function(t,r,a,l){n.value="004",e.querySelector("#btnModal").click()},className:"font-bold"},{text:'<i class="fa-solid fa-eye text-orange-500"></i> Ver',action:function(t,a,l,o){n.value="005",openModal(t,a,l,o,e,r,v,x)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});break;case"004":f&&f.destroy(),f=new DataTable("#tblSales",{dom:"Bfrtip",async:!0,ajax:{url:"../../app/controllers/SaleController.php",type:"GET",dataSrc:""},pageLength:15,loading:!0,columns:[{title:"ID",data:"codigo_factura"},{title:"Codigo",data:"numero"},{title:"Fecha de emisión",data:"fecha_transaccion"},{title:"Cliente",data:"cliente"},{title:"Responsable",data:"responsable"},{title:"Estado",data:"estado",render:function(e){switch(e){case"ACTIVO":return`\n                                        <div class="flex flex-row gap-2 items-center justify-between">\n                                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-green-100 text-green-800 border-green-400">${e}</span>\n                                        </div>\n                                    `;case"ANULADO":return`\n                                        <div class="flex flex-row gap-2 items-center justify-between">\n                                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-red-100 text-red-800 border-red-400">${e}</span>\n                                        </div>\n                                    `;case"DEVOLUCION":return`\n                                        <div class="flex flex-row gap-2 items-center justify-between">\n                                            <span class="text-xs w-full font-medium mr-2 px-2.5 py-0.5 rounded border bg-yellow-100 text-yellow-800 border-yellow-400">${e}</span>\n                                        </div>\n                                    `}}}],select:!0,responsive:!0,paging:!0,buttons:[{text:'<i class="fa-solid fa-circle-plus text-green-500"></i> Crear',action:function(t,a,l,o){n.value="001",openModal(t,a,l,o,e,r)},className:"font-bold"},{text:'<i class="fas fa-minus-circle text-red-500"></i> Anular',action:function(t,r,a,l){let o=r.row({selected:!0}).data();o?(n.value="002",e.querySelector("#txtCode").value=o.codigo_factura,e.querySelector("#btnModal").click()):alert("Aviso","Debe seleccionar un registro.","info","OK",!1)},className:"font-bold"},{text:'<i class="fas fa-calendar-times text-red-500"></i> Expiradas',action:function(t,r,a,l){n.value="003",e.querySelector("#btnModal").click()},className:"font-bold"},{text:'<i class="fa-solid fa-eye text-orange-500"></i> Ver',action:function(t,a,l,o){n.value="005",openModal(t,a,l,o,e,r,v,x)},className:"font-bold"}],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"}});break;default:break}})),o.addEventListener("submit",(async e=>{if(e.preventDefault(),function(){if(!validateRequired(t.querySelector("#txtName").value))return alert("Campo requerido","El nombre es requerido.","warning","Ok",!0),!1;if(!validateRequired(t.querySelector("#txtLastName").value))return alert("Campo requerido","El apellido es requerido.","warning","Ok",!0),!1;if(!validateRequired(t.querySelector("#txtAddress").value))return alert("Campo requerido","La dirección es requerida.","warning","Ok",!0),!1;if(!validateRequired(t.querySelector("#txtEmail").value))return alert("Campo requerido","El correo electrónico es requerido.","warning","Ok",!0),!1;if(!validateEmail(t.querySelector("#txtEmail").value))return alert("Campo requerido","El correo electrónico no es valido.","warning","Ok",!0),!1;return!0}()){const e={nombre:t.querySelector("#txtName").value,apellido:t.querySelector("#txtLastName").value,direccion:t.querySelector("#txtAddress").value,correo:t.querySelector("#txtEmail").value,telefono_fijo:t.querySelector("#txtPhone1").value||"N/A",telefono_movil:t.querySelector("#txtPhone2").value||"N/A"};let r=await send(e,"001C");if(r){let e=r?.success?"Transacción exitosa":"Error en la transacción",t=r?.success?"success":"warning";alert(e,r.message,t,"Ok",!0)}s.click()}}))}));